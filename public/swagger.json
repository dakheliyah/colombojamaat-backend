{
  "openapi": "3.0.0",
  "info": {
    "title": "Miqaat API",
    "description": "API documentation for Miqaat management system including Census, Events, Sharafs, and related operations",
    "version": "1.0.0",
    "contact": {
      "name": "API Support"
    }
  },
  "servers": [
    {
      "url": "/api",
      "description": "API Base URL"
    }
  ],
  "tags": [
    {
      "name": "Auth Session",
      "description": "Session / ITS from cookie (its_no)"
    },
    {
      "name": "Census",
      "description": "Census data operations"
    },
    {
      "name": "Families",
      "description": "Family summary operations"
    },
    {
      "name": "Users",
      "description": "User operations"
    },
    {
      "name": "Miqaats",
      "description": "Miqaat operations"
    },
    {
      "name": "Miqaat Check Definitions",
      "description": "CRUD for miqaat_check_definitions (department checks)"
    },
    {
      "name": "Miqaat Checks",
      "description": "List and upsert miqaat_checks for a person within a miqaat (Anjuman view)"
    },
    {
      "name": "Events",
      "description": "Event operations"
    },
    {
      "name": "Sharaf Definitions",
      "description": "Sharaf definition operations"
    },
    {
      "name": "Payment Definitions",
      "description": "Payment type definitions per sharaf definition"
    },
    {
      "name": "Sharaf Positions",
      "description": "Sharaf position operations"
    },
    {
      "name": "Sharafs",
      "description": "Sharaf operations"
    },
    {
      "name": "Sharaf Members",
      "description": "Sharaf member operations"
    },
    {
      "name": "Sharaf Clearances",
      "description": "Sharaf clearance operations"
    },
    {
      "name": "Sharaf Payments",
      "description": "Sharaf payment operations"
    },
    {
      "name": "Wajebaat",
      "description": "Wajebaat (Takhmeen / Finance Ada) operations"
    }
  ],
  "paths": {
    "/auth/session": {
      "get": {
        "tags": ["Auth Session"],
        "summary": "Get current session ITS number",
        "description": "Reads the its_no cookie from the request, decrypts if needed, and returns the plain ITS number. Requires credentials (cookies). Returns 401 when cookie is missing or invalid.",
        "responses": {
          "200": {
            "description": "Valid session",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": ["its_no"],
                  "properties": {
                    "its_no": {
                      "type": "string",
                      "description": "Plain ITS number from cookie",
                      "example": "30361286"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "No valid session (cookie missing or invalid)",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": { "type": "string", "example": "unauthorized" },
                    "message": { "type": "string", "example": "No valid session." }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/census": {
      "get": {
        "tags": ["Census"],
        "summary": "Get all census records",
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/census/search": {
      "get": {
        "tags": ["Census"],
        "summary": "Search census records",
        "parameters": [
          {
            "name": "q",
            "in": "query",
            "description": "Search query",
            "required": false,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/census/{its_id}": {
      "get": {
        "tags": ["Census"],
        "summary": "Get census record by ITS ID",
        "parameters": [
          {
            "name": "its_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "ITS ID of the person"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "404": {
            "description": "Not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/census/{its_id}/with-relations": {
      "get": {
        "tags": ["Census"],
        "summary": "Get census record with family relationships",
        "parameters": [
          {
            "name": "its_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "ITS ID of the person"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/census/family/{hof_its}": {
      "get": {
        "tags": ["Census"],
        "summary": "Get family members by Head of Family ITS",
        "parameters": [
          {
            "name": "hof_its",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Head of Family ITS ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/families/{hof_its}/summary": {
      "get": {
        "tags": ["Families"],
        "summary": "Get family summary",
        "parameters": [
          {
            "name": "hof_its",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Head of Family ITS ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/users/its/{its_no}": {
      "get": {
        "tags": ["Users"],
        "summary": "Get user by ITS number",
        "parameters": [
          {
            "name": "its_no",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "ITS number"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/miqaats": {
      "get": {
        "tags": ["Miqaats"],
        "summary": "Get all miqaats",
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Miqaats"],
        "summary": "Create a new miqaat",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "Name of the miqaat"
                  },
                  "date": {
                    "type": "string",
                    "format": "date",
                    "description": "Date of the miqaat"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/miqaat-check-definitions": {
      "get": {
        "tags": ["Miqaat Check Definitions"],
        "summary": "List miqaat check definitions",
        "description": "Paginated list, optionally filtered by miqaat_id. Ordered by miqaat_id then name.",
        "parameters": [
          {
            "name": "miqaat_id",
            "in": "query",
            "required": false,
            "schema": { "type": "integer" },
            "description": "Filter by miqaat (must exist in miqaats table)"
          },
          {
            "name": "user_type",
            "in": "query",
            "required": false,
            "schema": { "type": "string", "enum": ["BS", "Admin", "Help Desk", "Anjuman", "Finance"] },
            "description": "Filter by user_type (e.g. Anjuman). Values: BS, Admin, Help Desk, Anjuman, Finance"
          },
          {
            "name": "page",
            "in": "query",
            "required": false,
            "schema": { "type": "integer", "minimum": 1 },
            "description": "Page number (default: 1)"
          },
          {
            "name": "per_page",
            "in": "query",
            "required": false,
            "schema": { "type": "integer", "minimum": 1, "maximum": 100 },
            "description": "Items per page (default: 15)"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Miqaat Check Definitions"],
        "summary": "Create a miqaat check definition",
        "description": "Name must be unique within the given miqaat.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["miqaat_id", "name"],
                "properties": {
                  "miqaat_id": { "type": "integer", "description": "ID of the miqaat" },
                  "name": { "type": "string", "maxLength": 255, "description": "Name (unique per miqaat)" }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation error or duplicate name for miqaat",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/miqaat-check-definitions/{mcd_id}": {
      "get": {
        "tags": ["Miqaat Check Definitions"],
        "summary": "Get a single miqaat check definition",
        "parameters": [
          {
            "name": "mcd_id",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" },
            "description": "Primary key of the check definition"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "404": {
            "description": "Not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      },
      "put": {
        "tags": ["Miqaat Check Definitions"],
        "summary": "Update a miqaat check definition",
        "parameters": [
          {
            "name": "mcd_id",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["miqaat_id", "name"],
                "properties": {
                  "miqaat_id": { "type": "integer" },
                  "name": { "type": "string", "maxLength": 255 }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "404": {
            "description": "Not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      },
      "patch": {
        "tags": ["Miqaat Check Definitions"],
        "summary": "Update a miqaat check definition",
        "parameters": [
          {
            "name": "mcd_id",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["miqaat_id", "name"],
                "properties": {
                  "miqaat_id": { "type": "integer" },
                  "name": { "type": "string", "maxLength": 255 }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "404": {
            "description": "Not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      },
      "delete": {
        "tags": ["Miqaat Check Definitions"],
        "summary": "Delete a miqaat check definition",
        "description": "If miqaat_checks reference this definition, their mcd_id is set to null.",
        "parameters": [
          {
            "name": "mcd_id",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" }
          }
        ],
        "responses": {
          "200": {
            "description": "Deleted successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "404": {
            "description": "Not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/events": {
      "get": {
        "tags": ["Events"],
        "summary": "Get all events",
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Events"],
        "summary": "Create a new event",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "miqaat_id": {
                    "type": "integer",
                    "description": "ID of the miqaat"
                  },
                  "name": {
                    "type": "string",
                    "description": "Name of the event"
                  }
                },
                "required": ["miqaat_id", "name"]
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/events/{event_id}/sharaf-definitions": {
      "get": {
        "tags": ["Events", "Sharaf Definitions"],
        "summary": "Get sharaf definitions for an event",
        "parameters": [
          {
            "name": "event_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Event ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/events/{miqaat_id}": {
      "get": {
        "tags": ["Events"],
        "summary": "Get events by miqaat ID",
        "parameters": [
          {
            "name": "miqaat_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Miqaat ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/sharaf-definitions": {
      "post": {
        "tags": ["Sharaf Definitions"],
        "summary": "Create a new sharaf definition",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "event_id": {
                    "type": "integer",
                    "description": "ID of the event"
                  },
                  "name": {
                    "type": "string",
                    "description": "Name of the sharaf definition"
                  },
                  "description": {
                    "type": "string",
                    "description": "Description of the sharaf definition"
                  }
                },
                "required": ["event_id", "name"]
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/sharaf-definitions/{sd_id}/sharafs": {
      "get": {
        "tags": ["Sharaf Definitions", "Sharafs"],
        "summary": "Get sharafs for a sharaf definition",
        "parameters": [
          {
            "name": "sd_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Sharaf definition ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/sharaf-definitions/{id}/positions": {
      "get": {
        "tags": ["Sharaf Definitions", "Sharaf Positions"],
        "summary": "Get positions for a sharaf definition",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Sharaf definition ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/sharaf-definitions/{id}/payment-definitions": {
      "get": {
        "tags": ["Sharaf Definitions", "Payment Definitions"],
        "summary": "Get payment definitions for a sharaf definition",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" },
            "description": "Sharaf definition ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "404": {
            "description": "Sharaf definition not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/sharaf-positions": {
      "post": {
        "tags": ["Sharaf Positions"],
        "summary": "Create a new sharaf position",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "sharaf_definition_id": {
                    "type": "integer",
                    "description": "ID of the sharaf definition"
                  },
                  "name": {
                    "type": "string",
                    "description": "Name of the position"
                  },
                  "description": {
                    "type": "string",
                    "description": "Description of the position"
                  }
                },
                "required": ["sharaf_definition_id", "name"]
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/sharafs": {
      "get": {
        "tags": ["Sharafs"],
        "summary": "Get all sharafs with optional filtering",
        "parameters": [
          {
            "name": "sharaf_definition_id",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer"
            },
            "description": "Filter by sharaf definition ID"
          },
          {
            "name": "status",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "enum": ["pending", "bs_approved", "confirmed", "rejected", "cancelled"]
            },
            "description": "Filter by status"
          },
          {
            "name": "hof_its",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "Filter by Head of Family ITS"
          },
          {
            "name": "page",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1
            },
            "description": "Page number"
          },
          {
            "name": "per_page",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 100
            },
            "description": "Items per page"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Sharafs"],
        "summary": "Create a new sharaf",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateSharafRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/sharafs/{sharaf_id}": {
      "get": {
        "tags": ["Sharafs"],
        "summary": "Get a single sharaf",
        "parameters": [
          {
            "name": "sharaf_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Sharaf ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "404": {
            "description": "Not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      },
      "delete": {
        "tags": ["Sharafs"],
        "summary": "Delete a sharaf",
        "parameters": [
          {
            "name": "sharaf_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Sharaf ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Deleted successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "404": {
            "description": "Not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/sharafs/{sharaf_id}/status": {
      "put": {
        "tags": ["Sharafs"],
        "summary": "Update sharaf status",
        "parameters": [
          {
            "name": "sharaf_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Sharaf ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "status": {
                    "type": "string",
                    "enum": ["pending", "bs_approved", "confirmed", "rejected", "cancelled"],
                    "description": "New status"
                  }
                },
                "required": ["status"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      },
      "patch": {
        "tags": ["Sharafs"],
        "summary": "Update sharaf status",
        "parameters": [
          {
            "name": "sharaf_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Sharaf ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "status": {
                    "type": "string",
                    "enum": ["pending", "bs_approved", "confirmed", "rejected", "cancelled"],
                    "description": "New status"
                  }
                },
                "required": ["status"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/sharafs/{sharaf_id}/evaluate-confirmation": {
      "post": {
        "tags": ["Sharafs"],
        "summary": "Evaluate and update sharaf confirmation status",
        "parameters": [
          {
            "name": "sharaf_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Sharaf ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Evaluated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "404": {
            "description": "Not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/sharafs/{sharaf_id}/members": {
      "get": {
        "tags": ["Sharaf Members"],
        "summary": "Get all members assigned to a sharaf",
        "parameters": [
          {
            "name": "sharaf_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Sharaf ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Sharaf Members"],
        "summary": "Add a member to a sharaf",
        "parameters": [
          {
            "name": "sharaf_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Sharaf ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/AddSharafMemberRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Member added successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/sharafs/{sharaf_id}/members/{its}": {
      "delete": {
        "tags": ["Sharaf Members"],
        "summary": "Remove a member from a sharaf",
        "parameters": [
          {
            "name": "sharaf_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Sharaf ID"
          },
          {
            "name": "its",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "ITS number of the person to remove"
          }
        ],
        "responses": {
          "200": {
            "description": "Member removed successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/payment-definitions": {
      "get": {
        "tags": ["Payment Definitions"],
        "summary": "List payment definitions",
        "description": "Paginated list, optionally filtered by sharaf_definition_id.",
        "parameters": [
          {
            "name": "sharaf_definition_id",
            "in": "query",
            "required": false,
            "schema": { "type": "integer" },
            "description": "Filter by sharaf definition"
          },
          {
            "name": "page",
            "in": "query",
            "required": false,
            "schema": { "type": "integer", "minimum": 1 }
          },
          {
            "name": "per_page",
            "in": "query",
            "required": false,
            "schema": { "type": "integer", "minimum": 1, "maximum": 100 }
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Payment Definitions"],
        "summary": "Create a payment definition",
        "description": "Name must be unique per sharaf definition.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["sharaf_definition_id", "name"],
                "properties": {
                  "sharaf_definition_id": { "type": "integer", "description": "ID of the sharaf definition" },
                  "name": { "type": "string", "maxLength": 255 },
                  "description": { "type": "string", "nullable": true }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation error or duplicate name",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/sharaf-payments": {
      "get": {
        "tags": ["Sharaf Payments"],
        "summary": "List sharaf payments",
        "description": "Paginated list, optionally filtered by sharaf_id.",
        "parameters": [
          {
            "name": "sharaf_id",
            "in": "query",
            "required": false,
            "schema": { "type": "integer" }
          },
          {
            "name": "page",
            "in": "query",
            "required": false,
            "schema": { "type": "integer", "minimum": 1 }
          },
          {
            "name": "per_page",
            "in": "query",
            "required": false,
            "schema": { "type": "integer", "minimum": 1, "maximum": 100 }
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/sharafs/{sharaf_id}/clearances": {
      "post": {
        "tags": ["Sharaf Clearances"],
        "summary": "Toggle clearance status for a sharaf's Head of Family",
        "parameters": [
          {
            "name": "sharaf_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Sharaf ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "is_cleared": {
                    "type": "boolean",
                    "description": "Whether the clearance is complete"
                  },
                  "cleared_by_its": {
                    "type": "string",
                    "description": "ITS number of the person who cleared it"
                  }
                },
                "required": ["is_cleared"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Clearance updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/sharafs/{sharaf_id}/lagat": {
      "post": {
        "tags": ["Sharaf Payments"],
        "summary": "Toggle lagat payment status for a sharaf",
        "parameters": [
          {
            "name": "sharaf_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Sharaf ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "paid": {
                    "type": "boolean",
                    "description": "Whether lagat payment is paid"
                  }
                },
                "required": ["paid"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Payment status updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/sharafs/{sharaf_id}/najwa": {
      "post": {
        "tags": ["Sharaf Payments"],
        "summary": "Toggle najwa ada payment status for a sharaf",
        "parameters": [
          {
            "name": "sharaf_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Sharaf ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "paid": {
                    "type": "boolean",
                    "description": "Whether najwa ada payment is paid"
                  }
                },
                "required": ["paid"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Payment status updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/sharafs/{sharaf_id}/payments": {
      "post": {
        "tags": ["Sharaf Payments"],
        "summary": "Create or update a sharaf payment",
        "description": "Creates or updates a payment record for the sharaf. payment_status is set to false. Use lagat/najwa endpoints for toggling paid status.",
        "parameters": [
          {
            "name": "sharaf_id",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" },
            "description": "Sharaf ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["payment_definition_id", "payment_amount"],
                "properties": {
                  "payment_definition_id": { "type": "integer", "description": "ID of the payment definition" },
                  "payment_amount": { "type": "number", "minimum": 0, "description": "Payment amount" }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Created/updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "404": {
            "description": "Sharaf not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/wajebaat/takhmeen": {
      "post": {
        "tags": ["Wajebaat"],
        "summary": "Bulk-save Takhmeen amounts",
        "description": "Bulk-save Takhmeen amounts for multiple members. If an its_id is passed (as a separate field), the API checks if they belong to a wajebaat_groups and returns all associated members' data. Currency is stored as-is (no conversion at write-time).",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/TakhmeenStoreRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Takhmeen amounts saved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TakhmeenStoreResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/miqaats/{miqaat_id}/miqaat-checks": {
      "get": {
        "tags": ["Miqaat Checks"],
        "summary": "List miqaat checks for a person by miqaat",
        "description": "Returns all miqaat_checks for a given person (its_id) within the scope of a miqaat. Used by the Anjuman view to show which definitions are cleared/uncleared for the entered ITS number.",
        "parameters": [
          {
            "name": "miqaat_id",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" },
            "description": "Miqaat ID (must exist in miqaats)"
          },
          {
            "name": "its_id",
            "in": "query",
            "required": true,
            "schema": { "type": "string" },
            "description": "ITS ID of the person (census identifier)"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response (data: array of miqaat_check rows)",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": ["success", "data"],
                  "properties": {
                    "success": { "type": "boolean", "example": true },
                    "data": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": { "type": "integer" },
                          "its_id": { "type": "string" },
                          "mcd_id": { "type": "integer" },
                          "is_cleared": { "type": "boolean" },
                          "cleared_by_its": { "type": "string", "nullable": true },
                          "cleared_at": { "type": "string", "format": "date-time", "nullable": true },
                          "notes": { "type": "string", "nullable": true },
                          "created_at": { "type": "string", "format": "date-time" },
                          "updated_at": { "type": "string", "format": "date-time" }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Miqaat not found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean", "example": false },
                    "error": { "type": "string", "example": "NOT_FOUND" },
                    "message": { "type": "string", "example": "Miqaat not found." }
                  }
                }
              }
            }
          },
          "422": {
            "description": "Missing its_id",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean", "example": false },
                    "error": { "type": "string", "example": "VALIDATION_ERROR" },
                    "message": { "type": "string", "example": "The its_id parameter is required." }
                  }
                }
              }
            }
          }
        }
      },
      "put": {
        "tags": ["Miqaat Checks"],
        "summary": "Upsert a miqaat check (clear/unclear)",
        "description": "Creates or updates a single miqaat_checks row for a person and a check definition. Uniqueness is on (its_id, mcd_id). Used by the Anjuman view when the user toggles clear/unclear for a definition.",
        "parameters": [
          {
            "name": "miqaat_id",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" },
            "description": "Miqaat ID (must exist; used to validate that mcd_id belongs to this miqaat)"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["its_id", "mcd_id", "is_cleared"],
                "properties": {
                  "its_id": { "type": "string", "description": "ITS ID of the person" },
                  "mcd_id": { "type": "integer", "description": "Check definition ID (must belong to this miqaat)" },
                  "is_cleared": { "type": "boolean", "description": "Whether the check is cleared (true) or not (false)" },
                  "cleared_by_its": { "type": "string", "description": "ITS of the user performing the action (e.g. current Anjuman user)", "nullable": true },
                  "notes": { "type": "string", "description": "Optional notes", "nullable": true }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Updated successfully (data: miqaat_check row)",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": ["success", "data"],
                  "properties": {
                    "success": { "type": "boolean", "example": true },
                    "data": {
                      "type": "object",
                      "properties": {
                        "id": { "type": "integer" },
                        "its_id": { "type": "string" },
                        "mcd_id": { "type": "integer" },
                        "is_cleared": { "type": "boolean" },
                        "cleared_by_its": { "type": "string", "nullable": true },
                        "cleared_at": { "type": "string", "format": "date-time", "nullable": true },
                        "notes": { "type": "string", "nullable": true },
                        "created_at": { "type": "string", "format": "date-time" },
                        "updated_at": { "type": "string", "format": "date-time" }
                      }
                    }
                  }
                }
              }
            }
          },
          "201": {
            "description": "Created successfully (data: miqaat_check row)",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": ["success", "data"],
                  "properties": {
                    "success": { "type": "boolean", "example": true },
                    "data": {
                      "type": "object",
                      "properties": {
                        "id": { "type": "integer" },
                        "its_id": { "type": "string" },
                        "mcd_id": { "type": "integer" },
                        "is_cleared": { "type": "boolean" },
                        "cleared_by_its": { "type": "string", "nullable": true },
                        "cleared_at": { "type": "string", "format": "date-time", "nullable": true },
                        "notes": { "type": "string", "nullable": true },
                        "created_at": { "type": "string", "format": "date-time" },
                        "updated_at": { "type": "string", "format": "date-time" }
                      }
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Miqaat or check definition not found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean", "example": false },
                    "error": { "type": "string", "example": "NOT_FOUND" },
                    "message": { "type": "string", "example": "Miqaat or check definition not found." }
                  }
                }
              }
            }
          },
          "422": {
            "description": "Validation error (e.g. missing its_id, mcd_id, or is_cleared)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Miqaat Checks"],
        "summary": "Upsert a miqaat check (clear/unclear)",
        "description": "Same as PUT: creates or updates a single miqaat_checks row. Uniqueness is on (its_id, mcd_id).",
        "parameters": [
          {
            "name": "miqaat_id",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["its_id", "mcd_id", "is_cleared"],
                "properties": {
                  "its_id": { "type": "string" },
                  "mcd_id": { "type": "integer" },
                  "is_cleared": { "type": "boolean" },
                  "cleared_by_its": { "type": "string", "nullable": true },
                  "notes": { "type": "string", "nullable": true }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Updated successfully",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/SuccessResponse" }
              }
            }
          },
          "201": {
            "description": "Created successfully",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/SuccessResponse" }
              }
            }
          },
          "404": {
            "description": "Miqaat or check definition not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" }
              }
            }
          }
        }
      }
    },
    "/miqaats/{miqaat_id}/wajebaat/{its_id}": {
      "get": {
        "tags": ["Wajebaat"],
        "summary": "Get wajebaat for a member in a miqaat",
        "description": "Returns the single wajebaat record for the given miqaat and member. Returns 404 if no record exists.",
        "parameters": [
          {
            "name": "miqaat_id",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" },
            "description": "Miqaat ID"
          },
          {
            "name": "its_id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" },
            "description": "ITS ID of the member"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "404": {
            "description": "Wajebaat record not found for this miqaat and member",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/miqaats/{miqaat_id}/wajebaat/{its_id}/clearance": {
      "get": {
        "tags": ["Wajebaat"],
        "summary": "Get clearance status for a member in a miqaat",
        "description": "Returns wajebaat record (if any), pending department checks, and whether the member can be marked paid.",
        "parameters": [
          {
            "name": "miqaat_id",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" }
          },
          {
            "name": "its_id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response (data: wajebaat, pending_departments, can_mark_paid)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/miqaats/{miqaat_id}/wajebaat/{its_id}/paid": {
      "patch": {
        "tags": ["Wajebaat"],
        "summary": "Update Finance Ada payment status",
        "description": "Mark a member's wajebaat as paid or unpaid for a specific miqaat. Before saving paid=true, the controller queries the miqaat_checks table. If any check for that its_id is false (or missing), returns 403 Forbidden with a JSON payload listing the specific mcd_id names that are pending.",
        "parameters": [
          {
            "name": "miqaat_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Miqaat ID"
          },
          {
            "name": "its_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "ITS ID of the member"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["paid"],
                "properties": {
                  "paid": {
                    "type": "boolean",
                    "description": "Whether the wajebaat is paid",
                    "example": true
                  },
                  "is_isolated": {
                    "type": "boolean",
                    "description": "Whether this member is isolated (cannot be part of any group). If set to true, member will be removed from any existing groups.",
                    "nullable": true,
                    "example": false
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Payment status updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "403": {
            "description": "Department checks are pending",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DepartmentChecksPendingResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/miqaats/{miqaat_id}/wajebaat": {
      "get": {
        "tags": ["Wajebaat"],
        "summary": "Get all wajebaat records for a miqaat",
        "description": "Returns all wajebaat records for a specific miqaat. Returns empty array if no records exist (not 404).",
        "parameters": [
          {
            "name": "miqaat_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Miqaat ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": ["success", "data"],
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "data": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": { "type": "integer" },
                          "miqaat_id": { "type": "integer" },
                          "its_id": { "type": "string" },
                          "wg_id": { "type": "integer", "nullable": true },
                          "amount": { "type": "number", "format": "decimal" },
                          "currency": { "type": "string" },
                          "conversion_rate": { "type": "number", "format": "decimal" },
                          "status": { "type": "boolean" },
                          "wc_id": { "type": "integer", "nullable": true },
                          "is_isolated": { "type": "boolean", "description": "Whether this member is isolated (cannot be part of any group)" },
                          "created_at": { "type": "string", "format": "date-time" },
                          "updated_at": { "type": "string", "format": "date-time" },
                          "category": {
                            "type": "object",
                            "nullable": true,
                            "properties": {
                              "wc_id": { "type": "integer" },
                              "miqaat_id": { "type": "integer" },
                              "name": { "type": "string" },
                              "low_bar": { "type": "number", "format": "decimal" },
                              "upper_bar": { "type": "number", "format": "decimal" },
                              "hex_color": { "type": "string", "nullable": true },
                              "currency": { "type": "string" },
                              "order": { "type": "integer" }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/wajebaat/history/{its_id}": {
      "get": {
        "tags": ["Wajebaat"],
        "summary": "Get wajebaat history for an ITS ID",
        "description": "Returns all wajebaat records for a specific ITS ID across all miqaats. Ordered by created_at descending (most recent first). Returns empty array if no records exist (not 404).",
        "parameters": [
          {
            "name": "its_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "ITS ID of the member"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": ["success", "data"],
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "data": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": { "type": "integer" },
                          "miqaat_id": { "type": "integer" },
                          "its_id": { "type": "string" },
                          "wg_id": { "type": "integer", "nullable": true },
                          "amount": { "type": "number", "format": "decimal" },
                          "currency": { "type": "string" },
                          "conversion_rate": { "type": "number", "format": "decimal" },
                          "status": { "type": "boolean" },
                          "wc_id": { "type": "integer", "nullable": true },
                          "is_isolated": { "type": "boolean", "description": "Whether this member is isolated (cannot be part of any group)" },
                          "created_at": { "type": "string", "format": "date-time" },
                          "updated_at": { "type": "string", "format": "date-time" },
                          "category": {
                            "type": "object",
                            "nullable": true,
                            "properties": {
                              "wc_id": { "type": "integer" },
                              "miqaat_id": { "type": "integer" },
                              "name": { "type": "string" },
                              "low_bar": { "type": "number", "format": "decimal" },
                              "upper_bar": { "type": "number", "format": "decimal" },
                              "hex_color": { "type": "string", "nullable": true },
                              "currency": { "type": "string" },
                              "order": { "type": "integer" }
                            }
                          },
                          "miqaat": {
                            "type": "object",
                            "nullable": true,
                            "properties": {
                              "id": { "type": "integer" },
                              "name": { "type": "string" }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/miqaats/{miqaat_id}/wajebaat-categories": {
      "get": {
        "tags": ["Wajebaat"],
        "summary": "Get wajebaat categories for a miqaat",
        "description": "Returns all wajebaat categories configured for a specific miqaat. Ordered by low_bar ascending. Returns empty array if no categories exist (not 404).",
        "parameters": [
          {
            "name": "miqaat_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Miqaat ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": ["success", "data"],
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "data": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": { "type": "integer", "description": "Category ID (alias for wc_id)" },
                          "wc_id": { "type": "integer" },
                          "miqaat_id": { "type": "integer" },
                          "name": { "type": "string" },
                          "low_bar": { "type": "number", "format": "decimal" },
                          "upper_bar": { "type": "number", "format": "decimal" },
                          "hex_color": { "type": "string", "nullable": true },
                          "color": { "type": "string", "nullable": true, "description": "Alias for hex_color" },
                          "currency": { "type": "string" },
                          "order": { "type": "integer" },
                          "created_at": { "type": "string", "format": "date-time" },
                          "updated_at": { "type": "string", "format": "date-time" }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/miqaats/{miqaat_id}/wajebaat-groups": {
      "get": {
        "tags": ["Wajebaat"],
        "summary": "List all wajebaat groups for a miqaat",
        "description": "Returns all wajebaat groups for a specific miqaat. Returns empty array if no groups exist (not 404).",
        "parameters": [
          {
            "name": "miqaat_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Miqaat ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": ["success", "data"],
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "data": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/GroupData"
                      }
                    }
                  }
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Wajebaat"],
        "summary": "Create a new wajebaat group",
        "description": "Creates a new wajebaat group with a master and members. Master ITS must be included in members array. All members must not belong to another group.",
        "parameters": [
          {
            "name": "miqaat_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Miqaat ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["master_its", "member_its_ids"],
                "properties": {
                  "master_its": {
                    "type": "string",
                    "description": "ITS ID of the group master (must exist in census)"
                  },
                  "member_its_ids": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    },
                    "description": "Array of ITS IDs for group members (must exist in census, at least one required)"
                  },
                  "group_name": {
                    "type": "string",
                    "nullable": true,
                    "description": "Optional group name"
                  },
                  "group_type": {
                    "type": "string",
                    "enum": ["business_grouping", "personal_grouping", "organization"],
                    "nullable": true,
                    "description": "Optional group type"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Group created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": ["success", "data"],
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "data": {
                      "$ref": "#/components/schemas/GroupData"
                    }
                  }
                }
              }
            }
          },
          "422": {
            "description": "Validation error or isolated member",
            "content": {
              "application/json": {
                "schema": {
                  "oneOf": [
                    {
                      "$ref": "#/components/schemas/ErrorResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "success": {
                          "type": "boolean",
                          "example": false
                        },
                        "error": {
                          "type": "string",
                          "example": "ISOLATED_MEMBER"
                        },
                        "message": {
                          "type": "string",
                          "example": "One or more members are marked as isolated and cannot be part of any group."
                        },
                        "isolated_its_ids": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "409": {
            "description": "Conflict - one or more members already belong to another group",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": false
                    },
                    "error": {
                      "type": "string",
                      "example": "CONFLICT"
                    },
                    "message": {
                      "type": "string",
                      "example": "One or more members already belong to another group."
                    },
                    "conflicting_its_ids": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/miqaats/{miqaat_id}/wajebaat-groups/{wg_id}": {
      "get": {
        "tags": ["Wajebaat"],
        "summary": "Get wajebaat group members",
        "description": "Returns all members of a wajebaat group with their census and wajebaat data. Returns 404 if group doesn't exist.",
        "parameters": [
          {
            "name": "miqaat_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Miqaat ID"
          },
          {
            "name": "wg_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Wajebaat Group ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": ["success", "data"],
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "data": {
                      "type": "object",
                      "properties": {
                        "wg_id": { "type": "integer" },
                        "master_its": { "type": "string" },
                        "group_name": { "type": "string", "nullable": true },
                        "group_type": { "type": "string", "nullable": true, "enum": ["business_grouping", "personal_grouping", "organization"] },
                        "members": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "its_id": { "type": "string" },
                              "person": {
                                "type": "object",
                                "nullable": true,
                                "description": "Census record for the member"
                              },
                              "wajebaat": {
                                "type": "object",
                                "nullable": true,
                                "description": "Wajebaat record for the member in this miqaat, or null if no record exists"
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Wajebaat group not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      },
      "put": {
        "tags": ["Wajebaat"],
        "summary": "Update an existing wajebaat group",
        "description": "Updates an existing wajebaat group. Can update master, members, group name, or group type. All members must not belong to another group.",
        "parameters": [
          {
            "name": "miqaat_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Miqaat ID"
          },
          {
            "name": "wg_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Wajebaat Group ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "master_its": {
                    "type": "string",
                    "nullable": true,
                    "description": "ITS ID of the group master (must exist in census)"
                  },
                  "member_its_ids": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    },
                    "nullable": true,
                    "description": "Array of ITS IDs for group members (must exist in census, at least one if provided)"
                  },
                  "group_name": {
                    "type": "string",
                    "nullable": true,
                    "description": "Optional group name"
                  },
                  "group_type": {
                    "type": "string",
                    "enum": ["business_grouping", "personal_grouping", "organization"],
                    "nullable": true,
                    "description": "Optional group type"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Group updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": ["success", "data"],
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "data": {
                      "$ref": "#/components/schemas/GroupData"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Wajebaat group not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation error or isolated member",
            "content": {
              "application/json": {
                "schema": {
                  "oneOf": [
                    {
                      "$ref": "#/components/schemas/ErrorResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "success": {
                          "type": "boolean",
                          "example": false
                        },
                        "error": {
                          "type": "string",
                          "example": "ISOLATED_MEMBER"
                        },
                        "message": {
                          "type": "string",
                          "example": "One or more members are marked as isolated and cannot be part of any group."
                        },
                        "isolated_its_ids": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "409": {
            "description": "Conflict - one or more members already belong to another group",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": false
                    },
                    "error": {
                      "type": "string",
                      "example": "CONFLICT"
                    },
                    "message": {
                      "type": "string",
                      "example": "One or more members already belong to another group."
                    },
                    "conflicting_its_ids": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      "delete": {
        "tags": ["Wajebaat"],
        "summary": "Delete a wajebaat group",
        "description": "Deletes a wajebaat group and sets wajebaat.wg_id to null for all members (cascade).",
        "parameters": [
          {
            "name": "miqaat_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Miqaat ID"
          },
          {
            "name": "wg_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "Wajebaat Group ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Group deleted successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": ["success", "message"],
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "message": {
                      "type": "string",
                      "example": "Wajebaat group deleted successfully."
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Wajebaat group not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "SuccessResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "example": true
          },
          "data": {
            "type": "object",
            "description": "Response data"
          }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "error": {
            "type": "string",
            "example": "VALIDATION_ERROR"
          },
          "message": {
            "type": "string",
            "example": "The field is required."
          }
        }
      },
      "CreateSharafRequest": {
        "type": "object",
        "required": ["sharaf_definition_id", "rank", "capacity", "hof_its"],
        "properties": {
          "sharaf_definition_id": {
            "type": "integer",
            "description": "ID of the sharaf definition (must exist in sharaf_definitions table)",
            "example": 1
          },
          "rank": {
            "type": "integer",
            "description": "Rank of the sharaf (must be unique within the sharaf_definition_id, minimum: 1)",
            "minimum": 1,
            "example": 1
          },
          "name": {
            "type": "string",
            "description": "Name of the sharaf (max 255 characters)",
            "maxLength": 255,
            "example": "Sharaf Group 1"
          },
          "capacity": {
            "type": "integer",
            "description": "Maximum number of people in the sharaf (minimum: 1)",
            "minimum": 1,
            "example": 10
          },
          "status": {
            "type": "string",
            "enum": ["pending", "bs_approved", "confirmed", "rejected", "cancelled"],
            "description": "Status of the sharaf",
            "default": "pending",
            "example": "pending"
          },
          "hof_its": {
            "type": "string",
            "description": "ITS number of the Head of Family",
            "example": "123456"
          }
        }
      },
      "AddSharafMemberRequest": {
        "type": "object",
        "required": ["its", "position_id"],
        "properties": {
          "its": {
            "type": "string",
            "description": "ITS number of the person to add",
            "example": "123456"
          },
          "position_id": {
            "type": "integer",
            "description": "ID of the sharaf position (must exist in sharaf_positions table)",
            "example": 1
          },
          "sp_keyno": {
            "type": "integer",
            "description": "Key number for ordering within the position",
            "example": 1
          }
        }
      },
      "TakhmeenStoreRequest": {
        "type": "object",
        "required": ["miqaat_id", "entries"],
        "properties": {
          "miqaat_id": {
            "type": "integer",
            "description": "ID of the miqaat",
            "example": 1
          },
          "entries": {
            "type": "array",
            "description": "Array of Takhmeen entries to save (1-1000 items)",
            "minItems": 1,
            "maxItems": 1000,
            "items": {
              "type": "object",
              "required": ["its_id", "amount"],
              "properties": {
                "its_id": {
                  "type": "string",
                  "description": "ITS ID of the member (must exist in census table)",
                  "example": "123456"
                },
                "amount": {
                  "type": "number",
                  "description": "Takhmeen amount (minimum: 0)",
                  "minimum": 0,
                  "example": 5000.00
                },
                "currency": {
                  "type": "string",
                  "description": "Currency code (3 characters, e.g., LKR, USD)",
                  "minLength": 3,
                  "maxLength": 3,
                  "example": "LKR",
                  "default": "LKR"
                },
                "conversion_rate": {
                  "type": "number",
                  "description": "Conversion rate for reporting purposes only (does not affect stored amount)",
                  "minimum": 0.000001,
                  "example": 1.0,
                  "default": 1.0
                },
                "is_isolated": {
                  "type": "boolean",
                  "description": "Whether this member is isolated (cannot be part of any group). If set to true, member will be removed from any existing groups.",
                  "nullable": true,
                  "example": false
                }
              }
            }
          },
          "its_id": {
            "type": "string",
            "description": "Optional: If provided, checks if this ITS belongs to a wajebaat_groups and returns all associated members' data",
            "example": "123456"
          }
        }
      },
      "TakhmeenStoreResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "example": true
          },
          "data": {
            "type": "object",
            "properties": {
              "saved": {
                "type": "array",
                "description": "Array of saved wajebaat records",
                "items": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "integer",
                      "example": 1
                    },
                    "miqaat_id": {
                      "type": "integer",
                      "example": 1
                    },
                    "its_id": {
                      "type": "string",
                      "example": "123456"
                    },
                    "wg_id": {
                      "type": "integer",
                      "nullable": true,
                      "description": "Group ID if member belongs to a wajebaat group",
                      "example": 5
                    },
                    "amount": {
                      "type": "number",
                      "example": 5000.00
                    },
                    "currency": {
                      "type": "string",
                      "example": "LKR"
                    },
                    "conversion_rate": {
                      "type": "number",
                      "example": 1.0
                    },
                    "status": {
                      "type": "boolean",
                      "description": "Payment status (false = unpaid, true = paid)",
                      "example": false
                    },
                    "wc_id": {
                      "type": "integer",
                      "nullable": true,
                      "description": "Category ID (auto-assigned based on amount)",
                      "example": 2
                    },
                    "is_isolated": {
                      "type": "boolean",
                      "description": "Whether this member is isolated (cannot be part of any group)",
                      "example": false
                    },
                    "created_at": {
                      "type": "string",
                      "format": "date-time"
                    },
                    "updated_at": {
                      "type": "string",
                      "format": "date-time"
                    }
                  }
                }
              },
              "group": {
                "type": "object",
                "nullable": true,
                "description": "Group data (only present if its_id was provided and member belongs to a group)",
                "properties": {
                  "wg_id": {
                    "type": "integer",
                    "example": 5
                  },
                  "group_name": {
                    "type": "string",
                    "nullable": true,
                    "description": "Name of the group",
                    "example": "Family Group A"
                  },
                  "group_type": {
                    "type": "string",
                    "nullable": true,
                    "enum": ["business_grouping", "personal_grouping", "organization"],
                    "description": "Type of the group",
                    "example": "personal_grouping"
                  },
                  "master_its": {
                    "type": "string",
                    "example": "123456"
                  },
                  "members": {
                    "type": "array",
                    "description": "All members in the group",
                    "items": {
                      "type": "object",
                      "properties": {
                        "its_id": {
                          "type": "string",
                          "example": "123456"
                        },
                        "person": {
                          "type": "object",
                          "description": "Census record for the member",
                          "nullable": true
                        },
                        "wajebaat": {
                          "type": "object",
                          "description": "Wajebaat record for the member",
                          "nullable": true
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      "DepartmentChecksPendingResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "example": false
          },
          "error": {
            "type": "string",
            "example": "DEPARTMENT_CHECKS_PENDING"
          },
          "message": {
            "type": "string",
            "example": "Cannot mark as paid: department checks are pending."
          },
          "pending_departments": {
            "type": "array",
            "description": "List of pending departments with mcd_id and name",
            "items": {
              "type": "object",
              "properties": {
                "mcd_id": {
                  "type": "integer",
                  "description": "Department check ID",
                  "example": 1
                },
                "name": {
                  "type": "string",
                  "description": "Department name",
                  "example": "Finance"
                }
              }
            }
          }
        }
      }
    },
    "GroupData": {
      "type": "object",
      "properties": {
        "wg_id": {
          "type": "integer",
          "description": "Wajebaat Group ID"
        },
        "master_its": {
          "type": "string",
          "description": "ITS ID of the group master"
        },
        "group_name": {
          "type": "string",
          "nullable": true,
          "description": "Group name"
        },
        "group_type": {
          "type": "string",
          "nullable": true,
          "enum": ["business_grouping", "personal_grouping", "organization"],
          "description": "Group type"
        },
        "members": {
          "type": "array",
          "description": "Array of group members",
          "items": {
            "type": "object",
            "properties": {
              "its_id": {
                "type": "string",
                "description": "ITS ID of the member"
              },
              "person": {
                "type": "object",
                "nullable": true,
                "description": "Census record for the member"
              },
              "wajebaat": {
                "type": "object",
                "nullable": true,
                "description": "Wajebaat record for the member in this miqaat, or null if no record exists"
              }
            }
          }
        }
      }
    }
  }
}
